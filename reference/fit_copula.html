<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fit the copula model — fit_copula • scDesign3</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit the copula model — fit_copula"><meta name="description" content="fit_copula fits the copula model."><meta property="og:description" content="fit_copula fits the copula model."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">scDesign3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/scDesign3.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SONGDONGYUAN1994/scDesign3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fit the copula model</h1>
      <small class="dont-index">Source: <a href="https://github.com/SONGDONGYUAN1994/scDesign3/blob/main/R/fit_copula.R" class="external-link"><code>R/fit_copula.R</code></a></small>
      <div class="d-none name"><code>fit_copula.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>fit_copula</code> fits the copula model.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fit_copula</span><span class="op">(</span></span>
<span>  <span class="va">sce</span>,</span>
<span>  <span class="va">assay_use</span>,</span>
<span>  <span class="va">input_data</span>,</span>
<span>  empirical_quantile <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">marginal_list</span>,</span>
<span>  <span class="va">family_use</span>,</span>
<span>  copula <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  DT <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pseudo_obs <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  epsilon <span class="op">=</span> <span class="fl">1e-06</span>,</span>
<span>  family_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gaussian"</span>, <span class="st">"indep"</span><span class="op">)</span>,</span>
<span>  important_feature <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>  if_sparse <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  correlation_function <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>  <span class="va">n_cores</span>,</span>
<span>  parallelization <span class="op">=</span> <span class="st">"mcmapply"</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-sce">sce<a class="anchor" aria-label="anchor" href="#arg-sce"></a></dt>
<dd><p>A <code>SingleCellExperiment</code> object.</p></dd>


<dt id="arg-assay-use">assay_use<a class="anchor" aria-label="anchor" href="#arg-assay-use"></a></dt>
<dd><p>A string which indicates the assay you will use in the sce.
Default is 'counts'.</p></dd>


<dt id="arg-input-data">input_data<a class="anchor" aria-label="anchor" href="#arg-input-data"></a></dt>
<dd><p>The input data, which is one of the output from <code><a href="construct_data.html">construct_data</a></code>.</p></dd>


<dt id="arg-empirical-quantile">empirical_quantile<a class="anchor" aria-label="anchor" href="#arg-empirical-quantile"></a></dt>
<dd><p>Please only use it if you clearly know what will happen! A logic variable. If TRUE, DO NOT fit the copula and use the EMPIRICAL CDF values of the original data; it will make the simulated data fixed (no randomness). Default is FALSE. Only works if ncell is the same as your original data.</p></dd>


<dt id="arg-marginal-list">marginal_list<a class="anchor" aria-label="anchor" href="#arg-marginal-list"></a></dt>
<dd><p>A list of fitted regression models from <code><a href="fit_marginal.html">fit_marginal</a></code>.</p></dd>


<dt id="arg-family-use">family_use<a class="anchor" aria-label="anchor" href="#arg-family-use"></a></dt>
<dd><p>A string or a vector of strings of the marginal distribution. Must be one of 'poisson', 'nb', 'zip', 'zinb' or 'gaussian'.</p></dd>


<dt id="arg-copula">copula<a class="anchor" aria-label="anchor" href="#arg-copula"></a></dt>
<dd><p>A string of the copula choice. Must be one of 'gaussian' or 'vine'. Default is 'gaussian'. Note that vine copula may have better modeling of high-dimensions, but can be very slow when features are &gt;1000.</p></dd>


<dt id="arg-dt">DT<a class="anchor" aria-label="anchor" href="#arg-dt"></a></dt>
<dd><p>A logic variable. If TRUE, perform the distributional transformation
to make the discrete data 'continuous'. This is useful for discrete distributions (e.g., Poisson, NB).
Default is TRUE. Note that for continuous data (e.g., Gaussian), DT does not make sense and should be set as FALSE.</p></dd>


<dt id="arg-pseudo-obs">pseudo_obs<a class="anchor" aria-label="anchor" href="#arg-pseudo-obs"></a></dt>
<dd><p>A logic variable. If TRUE, use the empirical quantiles instead of theoretical quantiles for fitting copula.
Default is FALSE.</p></dd>


<dt id="arg-epsilon">epsilon<a class="anchor" aria-label="anchor" href="#arg-epsilon"></a></dt>
<dd><p>A numeric variable for preventing the transformed quantiles to collapse to 0 or 1.</p></dd>


<dt id="arg-family-set">family_set<a class="anchor" aria-label="anchor" href="#arg-family-set"></a></dt>
<dd><p>A string or a string vector of the bivariate copula families. Default is c("gaussian", "indep").</p></dd>


<dt id="arg-important-feature">important_feature<a class="anchor" aria-label="anchor" href="#arg-important-feature"></a></dt>
<dd><p>A numeric value or vector which indicates whether a gene will be used in correlation estimation or not. If this is a numeric value, then
gene with zero proportion greater than this value will be excluded form gene-gene correlation estimation. If this is a vector, then this should
be a logical vector with length equal to the number of genes in <code>sce</code>. <code>TRUE</code> in the logical vector means the corresponding gene will be included in
gene-gene correlation estimation and <code>FALSE</code> in the logical vector means the corresponding gene will be excluded from the gene-gene correlation estimation.
The default value for is "all" (a special string which means no filtering).</p></dd>


<dt id="arg-if-sparse">if_sparse<a class="anchor" aria-label="anchor" href="#arg-if-sparse"></a></dt>
<dd><p>A logic variable. Only works for Gaussian copula (<code>family_set = "gaussian"</code>). If TRUE, a thresholding strategy will make the corr matrix sparse.</p></dd>


<dt id="arg-correlation-function">correlation_function<a class="anchor" aria-label="anchor" href="#arg-correlation-function"></a></dt>
<dd><p>A string. If 'default', the function from <code>Rfast</code>; if 'coop', the function from <code>coop</code>, which calls BLAS.</p></dd>


<dt id="arg-n-cores">n_cores<a class="anchor" aria-label="anchor" href="#arg-n-cores"></a></dt>
<dd><p>An integer. The number of cores to use.</p></dd>


<dt id="arg-parallelization">parallelization<a class="anchor" aria-label="anchor" href="#arg-parallelization"></a></dt>
<dd><p>A string indicating the specific parallelization function to use.
Must be one of 'mcmapply', 'bpmapply', or 'pbmcmapply', which corresponds to the parallelization function in the package
<code>parallel</code>,<code>BiocParallel</code>, and <code>pbmcapply</code> respectively. The default value is 'mcmapply'.</p></dd>


<dt id="arg-bpparam">BPPARAM<a class="anchor" aria-label="anchor" href="#arg-bpparam"></a></dt>
<dd><p>A <code>MulticoreParam</code> object or NULL. When the parameter parallelization = 'mcmapply' or 'pbmcmapply',
this parameter must be NULL. When the parameter parallelization = 'bpmapply',  this parameter must be one of the
<code>MulticoreParam</code> object offered by the package 'BiocParallel. The default value is NULL.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with the components:</p><dl><dt><code>new_mvu</code></dt>
<dd><p>A matrix of the new multivariate uniform distribution from the copula.</p></dd>

  <dt><code>copula_list</code></dt>
<dd><p>A list of the fitted copula model. If using Gaussian copula, a list of correlation matrices; if vine, a list of vine objects.</p></dd>

  <dt><code>model_aic</code></dt>
<dd><p>A vector of the marginal AIC and the copula AIC.</p></dd>

  <dt><code>model_bic</code></dt>
<dd><p>A vector of the marginal BIC and the copula BIC.</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function takes the result from <code><a href="fit_marginal.html">fit_marginal</a></code> as the input and
and fit the copula model on the residuals.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="construct_data.html">construct_data</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  sce <span class="op">=</span> <span class="va">example_sce</span>,</span></span>
<span class="r-in"><span>  assay_use <span class="op">=</span> <span class="st">"counts"</span>,</span></span>
<span class="r-in"><span>  celltype <span class="op">=</span> <span class="st">"cell_type"</span>,</span></span>
<span class="r-in"><span>  pseudotime <span class="op">=</span> <span class="st">"pseudotime"</span>,</span></span>
<span class="r-in"><span>  spatial <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>  other_covariates <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>  corr_by <span class="op">=</span> <span class="st">"1"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">my_marginal</span> <span class="op">&lt;-</span> <span class="fu"><a href="fit_marginal.html">fit_marginal</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">my_data</span>,</span></span>
<span class="r-in"><span>  mu_formula <span class="op">=</span> <span class="st">"s(pseudotime, bs = 'cr', k = 10)"</span>,</span></span>
<span class="r-in"><span>  sigma_formula <span class="op">=</span> <span class="st">"1"</span>,</span></span>
<span class="r-in"><span>  family_use <span class="op">=</span> <span class="st">"nb"</span>,</span></span>
<span class="r-in"><span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  usebam <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">my_copula</span> <span class="op">&lt;-</span> <span class="fu">fit_copula</span><span class="op">(</span></span></span>
<span class="r-in"><span>  sce <span class="op">=</span> <span class="va">example_sce</span>,</span></span>
<span class="r-in"><span>  assay_use <span class="op">=</span> <span class="st">"counts"</span>,</span></span>
<span class="r-in"><span>  marginal_list <span class="op">=</span> <span class="va">my_marginal</span>,</span></span>
<span class="r-in"><span>  family_use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"nb"</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"zip"</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  copula <span class="op">=</span> <span class="st">"vine"</span>,</span></span>
<span class="r-in"><span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  input_data <span class="op">=</span> <span class="va">my_data</span><span class="op">$</span><span class="va">dat</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Convert Residuals to Uniform</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Converting End</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Copula group 1 starts</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Vine Copula Estimation Starts</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Time difference of 0.1357558 secs</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Vine Copula Estimation Ends</span>
<span class="r-in"><span>  </span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dongyuan Song, Qingyang Wang, Chenxin Jiang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

